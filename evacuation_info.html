<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>피난유도팀 구역별 임무</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* 기본 레이아웃 및 폰트 설정 */
        body { font-family: 'Noto Sans KR', Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        h1 { color: #d9534f; font-size: 1.8em; text-align: center; margin-bottom: 20px; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: #337ab7; text-decoration: none; font-weight: bold; }
        
        /* 탭 메뉴 컨테이너 */
        .tab-container { display: flex; justify-content: space-around; background-color: #eee; border-radius: 8px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { flex-grow: 1; text-align: center; padding: 15px 10px; border: none; background-color: transparent; font-weight: bold; color: #555; cursor: pointer; transition: background-color 0.2s, color 0.2s; white-space: nowrap; }
        .tab-btn.active { background-color: #337ab7; color: white; border-radius: 8px; }
        
        /* 탭 콘텐츠 영역 */
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }
        
        /* 구역 카드 스타일 (팝업 호출용) */
        .area-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 15px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .area-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .area-card h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; color: #333; }
        .area-summary { font-size: 0.9em; color: #777; }
        .area-card.common-mission { background-color: #fff3f3; border-left: 5px solid #d9534f; cursor: default; }
        .area-card.common-mission h3 { color: #d9534f; }

        /* 팝업 스타일 (구역별 체크리스트 팝업) */
        .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 1000; }
        .popup-content { 
            background-color: #fff; 
            padding: 25px; 
            border-radius: 10px; 
            width: 95%; 
            max-width: 550px; 
            position: relative; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); 
            max-height: 95vh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        .popup-close { position: absolute; top: 10px; right: 15px; font-size: 1.5em; color: #aaa; cursor: pointer; z-index: 20; }
        .popup-close:hover { color: #333; }

        /* 캡처 대상 컨테이너: 고정 헤더와 스크롤 컨텐츠를 포함 */
        #capture-target { 
            background-color: #fff; 
            border-radius: 5px; 
            margin-top: 5px; 
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            margin: -25px;
            padding: 0;
        }
        
        /* 상단 고정 헤더 컨테이너 */
        .fixed-header-container {
            background-color: #fff; 
            border-bottom: 1px solid #ddd;
            padding: 25px 25px 20px 25px; 
            z-index: 10;
        }

        /* 팝업 제목 및 요약 영역 */
        .popup-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .popup-title-group { display: flex; align-items: center; }
        .popup-title { font-size: 1.3em; color: #d9534f; margin: 0; }
        
        /* 뒤로가기 버튼 */
        #back-to-list-btn { 
            background-color: #eee; color: #555; border: none; padding: 5px 10px; 
            border-radius: 5px; font-size: 0.85em; cursor: pointer; margin-right: 15px;
            font-weight: bold; transition: background-color 0.2s;
        }
        #back-to-list-btn:hover { background-color: #ddd; }
        
        /* 이미지 스타일 */
        .popup-image { 
            max-width: 100%; 
            height: auto; 
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            display: block; 
            margin-top: 5px;
            margin-bottom: 0;
        }

        /* 스크롤 가능한 본문 영역 */
        #popup-scroll-content {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 0 25px; 
            padding-bottom: 25px;
        }
        
        /* 상세 체크리스트 스타일 */
        .checklist-wrapper { 
            margin-top: 0; 
            padding-bottom: 15px; 
            display: flex; 
            flex-wrap: wrap;
            gap: 0 20px; 
        }
        /* 2열 배열 스타일 */
        .checklist-wrapper.multi-column {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 0 20px;
        }
        /* 지원조 임무 텍스트 스타일 */
        #popup-detail-list p {
            margin-top: 0; 
            margin-bottom: 15px;
        }
        /* 지원조 임무 텍스트 내부 간격 확보 */
        #popup-detail-list strong {
            display: block;
            margin-top: 10px;
        }

        /* 체크리스트 아이템 스타일 (이하 동일) */
        .checklist-item {
            display: flex; 
            align-items: center;
            border-bottom: 1px solid #eee; 
            padding: 10px 0; 
            font-size: 1em; 
            cursor: pointer;
            width: 100%; 
        }
        .checklist-wrapper.multi-column .checklist-item {
            width: auto; 
        }

        .checklist-item:last-child { border-bottom: none; }
        
        /* 커스텀 체크박스 스타일 */
        .custom-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            transition: background-color 0.1s, border-color 0.1s;
        }

        /* 체크 상태 (취소선 및 체크마크) */
        .checklist-item.completed .custom-checkbox {
            background-color: #5cb85c;
            border-color: #5cb85c;
        }
        .custom-checkbox::after {
            content: '✔';
            color: white;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            transform: scale(0);
            transition: transform 0.1s;
        }
        .checklist-item.completed .custom-checkbox::after {
            transform: scale(1);
        }

        .item-name { 
            font-weight: 500; 
            color: #333; 
            flex-grow: 1;
            transition: text-decoration 0.2s, color 0.2s;
            line-height: 1.2;
        }
        
        .checklist-item.completed .item-name {
            text-decoration: line-through;
            color: #aaa;
        }
        
        /* 특이사항 입력 필드 컨테이너 */
        #memo-input-container {
            border-top: 1px solid #ddd;
            padding-top: 15px;
            margin-top: 10px;
        }

        /* 특이사항 입력 필드 (최대 크기 확보) */
        #global-memo-input { 
            width: 100%; 
            padding: 10px; 
            margin-top: 8px;
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 0.95em; 
            height: 120px; 
            resize: vertical;
        }


        /* 다운로드 버튼 스타일 */
        #download-btn { display: block; width: 100%; padding: 12px; margin-top: 20px; background-color: #337ab7; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #download-btn:hover { background-color: #286090; }

        /* 공통 임무 아코디언 스타일 */
        .sub-accordion-item { border: 1px solid #ddd; margin-top: 10px; border-radius: 5px; overflow: hidden; }
        .sub-accordion-header { background-color: #f7f7f7; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-bottom: 1px solid #ddd; }
        .sub-accordion-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #fff; }
        .sub-accordion-content.active { max-height: 500px; padding: 15px; } 


        /* 모바일 최적화 (550px 이하) - 2열 전환 미적용 */
        @media (max-width: 550px) {
            .checklist-wrapper.multi-column {
                grid-template-columns: 1fr; 
            }

            .popup-content { padding: 15px; }
            .fixed-header-container {
                padding: 15px 15px 15px 15px; 
            }
            #popup-scroll-content {
                padding: 0 15px;
                padding-bottom: 15px;
            }
            .popup-title { font-size: 1.2em; }
            #back-to-list-btn { margin-right: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="missions.html" class="back-btn">← 임무 목록으로 돌아가기</a>
        <h1>피난유도팀 구역별 임무 및 체크</h1>
        
        <div class="tab-container">
            <button class="tab-btn active" onclick="openTab(event, 'common-mission-tab')">공통 임무</button>
            <button class="tab-btn" onclick="openTab(event, 'floor1')">1층</button>
            <button class="tab-btn" onclick="openTab(event, 'floor2-4')">2~4층</button>
            <button class="tab-btn" onclick="openTab(event, 'basement-support')">지하 및 지원</button>
        </div>
        
        <div id="common-mission-tab" class="tab-content active">
            <div class="area-card common-mission">
                <h3>🚨 피난 유도 공통 필수 사항</h3>
                <p class="area-summary">비상 방송 청취, 엘리베이터 통제, 신속한 피난 유도 및 인원 파악 후 보고</p>
                <div id="common-mission-accordion-container">
                    </div>
            </div>
        </div>
        
        <div id="floor1" class="tab-content">
            <div class="area-card" onclick="openPopup('1층-1구역')"><h3>1층-1구역</h3><p class="area-summary">로비, 교육장, 1층 대회의실 등</p></div>
            <div class="area-card" onclick="openPopup('1층-2구역')"><h3>1층-2구역</h3><p class="area-summary">자재창고, GPU룸, GPU 용접실, 품질분석실 등</p></div>
            <div class="area-card" onclick="openPopup('1층-3구역')"><h3>1층-3구역</h3><p class="area-summary">주안 GSS룸, 1/2층 협력사 벤더 등</p></div>
            <div class="area-card" onclick="openPopup('1층-4구역')"><h3>1층-4구역</h3><p class="area-summary">GSS룸, GSS PA룸, IGS룸, 반출입구 등</p></div>
        </div>
        
        <div id="floor2-4" class="tab-content">
            <div class="area-card" onclick="openPopup('2층 구역')"><h3>2층 구역</h3><p class="area-summary">피트니스, 탈의실, 직원휴게실 등</p></div>
            <div class="area-card" onclick="openPopup('3층-1구역')"><h3>3층-1구역</h3><p class="area-summary">경영지원실, 부사장실, 대표이사실, 대회의실 등</p></div>
            <div class="area-card" onclick="openPopup('3층-2구역')"><h3>3층-2구역</h3><p class="area-summary">연구소WS, 생산기술WS, 전산실, 공조실 등</p></div>
            <div class="area-card" onclick="openPopup('4층 구역')"><h3>4층 구역</h3><p class="area-summary">카페, 식당 및 주방, 방재실 등</p></div>
        </div>

        <div id="basement-support" class="tab-content">
            <div class="area-card" onclick="openPopup('지하층 구역')"><h3>지하층 구역</h3><p class="area-summary">지하 연구실, 창고, 미화 협력사 휴게실 등</p></div>
            <div class="area-card" onclick="openPopup('지원조 임무')"><h3>지원조 임무</h3><p class="area-summary">게이트 앞, 옥외 등 인원 통제 및 집결지 안내</p></div>
        </div>
    </div>
    
    <div id="info-popup" class="popup">
        <div class="popup-content">
            <span class="popup-close" onclick="closePopup()">&times;</span>
            
            <div id="capture-target">
                
                <div class="fixed-header-container">
                    
                    <div class="popup-header-row">
                        <div class="popup-title-group">
                            <button id="back-to-list-btn" onclick="closePopup()">← 목록으로 돌아가기</button>
                            <h3 class="popup-title"></h3>
                        </div>
                        <span id="popup-status-summary" style="display:none;"></span>
                    </div>

                    <img id="popup-image" src="" alt="구역별 도면" class="popup-image">
                    
                    <div id="bulk-check-area" class="bulk-check-buttons" style="display:none;"></div>
                </div>
                
                <div id="popup-scroll-content">
                    <div id="popup-detail-list">
                        </div>
                </div>
            </div>
            
            <button id="download-btn" onclick="downloadChecklistAsImage()">체크리스트 이미지로 다운로드</button>
        </div>
    </div>
    
    <div id="hidden-containers" style="display: none;">
        <div id="checklist-items-container" class="checklist-wrapper"></div>
        <div id="memo-input-container">
            <h4>⭐ 특이사항 기록 (상황실 보고용)</h4>
            <textarea id="global-memo-input" placeholder="현장에서 인원 잔류, 장애물, 화재 지점 등 특이사항을 상세히 기록해주세요."></textarea>
        </div>
    </div>


    <script>
        // 구역별 임무 데이터 (체크리스트용)
        const areaData = {
            '1층-1구역': ['로비/접견실', '화장실/소회의실', '교육장', '중회의실2', '중회의실3','대회의실', '보건실', 'TC룸/TC룸 스막', 'GSS 측 화장실', '복도 1-1'],
            '1층-2구역': ['자재창고', 'GPU 스막', 'GPU', 'GPU 최종검사', 'GPU 용접실','GPU 준비실', '품질분석실', '복도 1-2'],
            '1층-3구역': ['주안 GSS 스막', '주안 GSS', '1층 협력사 벤더1', '1층 협력사 벤더2', '1층 협력사 벤더3','1층 협력사 벤더4', '1층 협력사 벤더5', '2층 협력사 벤더6', '2층 협력사 벤더7', '2층 협력사 벤더8','2층 협력사 벤더9', '2층 협력사 벤더10', '복도 1-3'],
            '1층-4구역': ['GSS 스막', 'GSS룸', 'GSS PA룸', 'IGS룸', 'GSS 최종검사실','소모품창고', '반출입구', '복도 1-4'],
            '2층 구역': ['피트니스', '탈의실', '화장실, 세탁실', '직원휴게실', '복도 2-1'],
            '3층-1구역': ['경영지원실/ 부사장실', '대회의실', '행복A 회의실', '행복B 회의실', '화장실', '탕비실','중회의실', '자유A 회의실', '자유B 회의실', '자유C 회의실', '자유D 회의실', '직속부서 WS', '영업팀 WS', '대표이사실', '복도 3-1'],
            '3층-2구역': ['연구소 WS', '생산기술WS', '고객지원창고', '소통A 회의실', '소통B 회의실','제조,CS WS', '전산실, 서버실', '제품TEST실', '제어 TEST실', '공조실','자재창고', '복도 3-2'],
            '4층 구역': ['카페', '식당 및 주방', '주방 휴게실', '다목적실','직원휴게실', '방재실', '문서고', '복도 4-1'],
            '지하층 구역': ['지하 연구실실', '창고', '미화 협력사 휴게실', '일반창고','컨트롤룸', '기계실', '전기실', '발전기실', '복도 B1'],
            '지원조 임무': '<strong>현장 안전통제 및 집결지 안내:</strong> GATE1, GATE2 앞 옥외 등 인원 밀집 예상 지역에서 안전을 확보하고 피난 유도.<br><br><strong>예비 인력 운영:</strong> 각 구역에 인원이 부재할 경우 즉시 투입하여 임무를 대행.'
        };

        // 이미지 데이터 (URL은 이전 예시와 동일)
        const imageData = {
            '1층-1구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150115_Chrome.jpg',
            '1층-2구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150115_Chrome.jpg',
            '1층-3구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150115_Chrome.jpg',
            '1층-4구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150115_Chrome.jpg',
            '2층 구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150110_Chrome.jpg',
            '3층-1구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150104_Chrome%20(1).jpg',
            '3층-2구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150104_Chrome%20(1).jpg',
            '4층 구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150104_Chrome.jpg',
            '지하층 구역': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150118_Chrome.jpg',
            '지원조 임무': 'https://github.com/hyunjiklee119-collab/FRT119/raw/1e608b49d98cc14d2f600551a0aed8bfa27e4dd0/Screenshot_20250925_150118_Chrome.jpg' 
        };

        // 공통 임무 아코디언 데이터 (기존과 동일)
        const missionData = {
            '공통 임무 상세': {
                title: '피난 유도팀 공통 필수 임무',
                content: [
                    { title: '1. 비상 상황 청취 및 전파', description: '<ul><li>비상 방송 청취 즉시 임무 수행</li><li>화재 발생 지점 확인 및 상황실에 보고</li><li>담당 구역 인원에게 상황 전파 및 경각심 부여</li></ul>' },
                    { title: '2. 신속한 피난 유도', description: '<ul><li>피난 유도 시 **엘리베이터 사용 절대 금지** (비상계단 이용 유도)</li><li>피난로 상의 장애물 신속 제거 및 개방</li><li>거동 불편자, 부상자 등 피난 약자 우선 유도</li></ul>' },
                    { title: '3. 인원 통제 및 집결', description: '<ul><li>담당 구역 인원이 모두 대피했는지 꼼꼼히 확인 (화장실, 회의실 등)</li><li>피난 완료 후 **지정된 집결지**로 안전하게 이동</li><li>외부 인원의 건물 진입 통제</li></ul>' },
                    { title: '4. 상황 보고 및 후속 조치', description: '<ul><li>집결지에서 **인원 파악** (누락 인원 포함)</li><li>상황실에 담당 구역 피난 완료 및 인원 현황 최종 보고</li><li>외부 소방대원 도착 시 현장 정보 제공 및 협조</li></ul>' }
                ]
            }
        };

        // --- LocalStorage 상태 관리 함수 ---

        // 완료 상태만 저장 (true/false)
        function saveCompletionStatus(area, index, isCompleted) {
            const key = `${area}-${index}-completed`;
            localStorage.setItem(key, isCompleted ? 'true' : 'false');
        }

        // 완료 상태 로드
        function loadCompletionStatus(area, index) {
            const key = `${area}-${index}-completed`;
            return localStorage.getItem(key) === 'true';
        }

        // 특이사항 메모 저장 (전역 메모)
        function saveGlobalMemo(area, content) {
            const key = `${area}-global-memo`;
            localStorage.setItem(key, content);
        }

        // 특이사항 메모 로드 (전역 메모)
        function loadGlobalMemo(area) {
            const key = `${area}-global-memo`;
            return localStorage.getItem(key) || '';
        }
        
        // --- 팝업 로직 ---

        // 팝업 열기 기능
        function openPopup(area) {
            const popup = document.getElementById('info-popup');
            const popupTitle = popup.querySelector('.popup-title');
            const popupImage = document.getElementById('popup-image');
            const popupDetailList = document.getElementById('popup-scroll-content').querySelector('#popup-detail-list');
            const downloadBtn = document.getElementById('download-btn');
            const backBtn = document.getElementById('back-to-list-btn');

            
            popup.setAttribute('data-current-area', area);
            popupTitle.textContent = area;
            
            // ❗ 문제 해결: 팝업 내용을 초기화합니다.
            popupDetailList.innerHTML = ''; 
            
            // ⭐ 문제 해결: 숨김 컨테이너에서 원형 요소를 복사하여 가져옵니다.
            const hiddenContainer = document.getElementById('hidden-containers');
            const checklistContainer = hiddenContainer.querySelector('#checklist-items-container').cloneNode(true);
            const memoContainer = hiddenContainer.querySelector('#memo-input-container').cloneNode(true);


            const data = areaData[area];
            
            if (Array.isArray(data)) {
                // 일반 구역 (체크리스트 O, 이미지 O/X, 다운로드 O)
                
                // DOM에 복사한 체크리스트와 메모 컨테이너 삽입
                popupDetailList.appendChild(checklistContainer);
                popupDetailList.appendChild(memoContainer);

                // 이미지 표시/숨김
                if (imageData[area] && imageData[area] !== '') {
                    popupImage.src = imageData[area];
                    popupImage.style.display = 'block';
                } else {
                    popupImage.style.display = 'none';
                }

                backBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'block'; // 다운로드 버튼 표시
                memoContainer.style.display = 'block'; // 메모 입력란 표시
                
                
                // 2열 전환 여부 결정 (8개 초과 시)
                if (data.length > 8) {
                    checklistContainer.classList.add('multi-column');
                } else {
                    checklistContainer.classList.remove('multi-column');
                }

                // 체크리스트 항목 로드
                data.forEach((item, index) => {
                    const itemName = item;
                    const isCompleted = loadCompletionStatus(area, index); 

                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('checklist-item');
                    itemDiv.setAttribute('data-area', area);
                    itemDiv.setAttribute('data-index', index);
                    
                    if (isCompleted) {
                        itemDiv.classList.add('completed');
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="custom-checkbox"></div>
                        <div class="item-name">${itemName}</div>
                    `;
                    
                    // 이벤트 리스너를 새로 생성된 요소에 연결
                    itemDiv.addEventListener('click', () => toggleCompletion(area, index, itemDiv));

                    checklistContainer.appendChild(itemDiv);
                });

                // 전역 메모 로드 및 이벤트 리스너 설정
                const globalMemoInput = memoContainer.querySelector('#global-memo-input');
                globalMemoInput.value = loadGlobalMemo(area);
                globalMemoInput.oninput = (e) => saveGlobalMemo(area, e.target.value);

            } else if (typeof data === 'string') {
                // 지원조 임무 처리 (체크리스트 X, 이미지 X, 다운로드 X)
                
                // 이미지 숨김
                popupImage.style.display = 'none';
                
                // 다운로드 버튼 숨김
                downloadBtn.style.display = 'none'; 
                
                // 텍스트 내용만 로드 (innerHTML로 대체)
                popupDetailList.innerHTML = `<p>${data}</p>`; 
                
                // 나머지 요소 숨김 (복사된 memoContainer는 어차피 popupDetailList에 삽입되지 않음)
                document.getElementById('popup-status-summary').style.display = 'none'; 
                backBtn.style.display = 'inline-block';
            }

            popup.style.display = 'flex';
        }

        // 팝업 닫기 기능
        function closePopup() {
            document.getElementById('info-popup').style.display = 'none';
            
            // 팝업 닫을 때 스크롤 위치 초기화
            const scrollContent = document.getElementById('popup-scroll-content');
            if (scrollContent) {
                scrollContent.scrollTop = 0;
            }
        }
        
        // 팝업 외부 클릭 시 닫기
        window.addEventListener('click', function(event) {
            const infoPopup = document.getElementById('info-popup');
            if (event.target === infoPopup) {
                closePopup();
            }
        });

        // --- 체크리스트 조작 함수 (취소선 토글) ---

        // 완료 상태를 토글하고 DOM 및 LocalStorage 업데이트
        function toggleCompletion(area, index, itemElement) {
            const isCompleted = itemElement.classList.toggle('completed');
            saveCompletionStatus(area, index, isCompleted);
        }
        
        // --- 이미지 캡처 함수 (일반 구역만 동작) ---

        function downloadChecklistAsImage() {
            const area = document.getElementById('info-popup').getAttribute('data-current-area');

            if (area === '지원조 임무') {
                alert("지원조 임무는 별도의 체크리스트가 없어 이미지 저장 기능을 지원하지 않습니다.");
                return;
            }

            const captureTarget = document.getElementById('capture-target');
            const popupTitle = area || document.querySelector('#info-popup .popup-title').textContent;
            
            // 캡처 전에 입력 필드의 현재 값을 DOM에 반영 (중요)
            // 캡처 대상 내부에서 메모 입력 필드를 찾습니다.
            const globalMemoInput = captureTarget.querySelector('#global-memo-input');
            if(globalMemoInput) {
                // 텍스트에어리어의 value 속성을 설정하여 html2canvas가 내용을 읽을 수 있도록 함
                globalMemoInput.setAttribute('value', globalMemoInput.value); 
            }

            // 캡처 전에 고정 헤더 영역의 스타일 임시 변경 (sticky 해제)
            const fixedHeader = captureTarget.querySelector('.fixed-header-container');
            if(fixedHeader) fixedHeader.style.position = 'static';

            // 캡처 시 뒤로가기 버튼 숨김
            const backBtn = document.getElementById('back-to-list-btn');
            const originalBackBtnDisplay = backBtn.style.display;
            backBtn.style.display = 'none';


            // 캡처를 위해 스크롤 컨텐츠의 높이를 임시 조정
            const scrollContent = document.getElementById('popup-scroll-content');
            const originalMaxHeight = scrollContent.style.maxHeight;
            const originalOverflow = scrollContent.style.overflowY;

            scrollContent.style.maxHeight = 'none'; // 스크롤을 풀고 전체 내용을 캡처
            scrollContent.style.overflowY = 'visible';


            html2canvas(captureTarget, {
                scale: 2, 
                logging: false,
                useCORS: true, 
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // 캡처 후 스타일 복원
                if(fixedHeader) fixedHeader.style.position = 'sticky'; 
                backBtn.style.display = originalBackBtnDisplay;
                scrollContent.style.maxHeight = originalMaxHeight; // 원본 maxHeight 복원
                scrollContent.style.overflowY = originalOverflow; // 원본 overflow 복원

                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                const date = new Date().toLocaleDateString('ko-KR').replace(/ /g, '').replace(/\./g, '_');
                link.download = `${popupTitle}_체크리스트_${date}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }


        // --- 공통 임무 아코디언 로드 (기존 유지) ---

        function loadCommonMissionAccordion(category, targetId) {
            const targetElement = document.getElementById(targetId);
            const data = missionData[category];
            targetElement.innerHTML = '';
            
            if (!data) return;

            data.content.forEach(item => {
                const accordionItem = document.createElement('div');
                accordionItem.classList.add('sub-accordion-item');
                
                const accordionHeader = document.createElement('div');
                accordionHeader.classList.add('sub-accordion-header');
                accordionHeader.innerHTML = `${item.title} <span>+</span>`; 
                
                const accordionContent = document.createElement('div');
                accordionContent.classList.add('sub-accordion-content');
                accordionContent.innerHTML = item.description; 
                
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionContent);
                targetElement.appendChild(accordionItem);
                
                accordionHeader.addEventListener('click', () => {
                    const isActive = accordionContent.classList.toggle('active');
                    const icon = accordionHeader.querySelector('span');
                    icon.textContent = isActive ? '−' : '+'; 
                });
            });
        }


        // 탭 열기 기능 (기존 유지)
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            const tablinks = document.getElementsByClassName("tab-btn");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // 공통 임무 탭이 열릴 때만 아코디언 로드
            if (tabName === 'common-mission-tab') {
                loadCommonMissionAccordion('공통 임무 상세', 'common-mission-accordion-container');
            }
        }


        // 페이지 로드 시 '공통 임무' 탭을 자동으로 활성화 (기존 유지)
        document.addEventListener('DOMContentLoaded', () => {
            const initialTabBtn = document.querySelector('.tab-btn.active');
            
            if (initialTabBtn) {
                loadCommonMissionAccordion('공통 임무 상세', 'common-mission-accordion-container');
            }
        });
    </script>
</body>
</html>
