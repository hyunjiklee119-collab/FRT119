<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화재대응 조직 임무</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #d9534f;
            --secondary-color: #337ab7;
            --background-color: #f4f4f4;
            --white-color: #fff;
            --light-red: #ffebeb;
            --light-blue: #eaf6ff;
            --text-color: #333;
        }

        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            width: 95%;
            max-width: 1024px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-top: 10px;
        }
        
        h2 {
            color: var(--secondary-color);
            font-size: clamp(1.2em, 4vw, 1.8em);
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            margin-top: 25px;
            text-align: center;
        }
        
        .wonik-logo {
            max-width: 60%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            background-color: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .contact-info {
            background-color: var(--light-red);
            border: 2px solid var(--primary-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .contact-info h2 {
            margin: 0;
            font-size: clamp(1.1em, 3.5vw, 1.6em);
            color: var(--primary-color);
            border-bottom: none;
        }
        
        .contact-info ul {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        
        .contact-info li {
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .contact-info li a {
            color: var(--text-color);
            text-decoration: none;
        }
        
        .common-actions .action-list p {
            margin: 8px 0; 
            padding-left: 20px;
            position: relative;
            font-size: 0.95em; 
        }
        
        .common-actions .action-list p:before {
            content: "•";
            color: var(--primary-color);
            position: absolute;
            left: 0;
            font-size: 1.2em;
            top: -2px; 
        }
        
        .common-actions .action-list p.numbered-guideline:before {
            content: attr(data-number) ".";
            font-weight: bold;
            color: var(--primary-color);
            left: 0;
            top: 0;
        }
        
        .link-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        .link-container a {
            display: block;
            text-align: center;
            background-color: var(--secondary-color);
            color: var(--white-color);
            padding: 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .link-container a:hover {
            background-color: #286090;
        }
        
        .my-role-section .dropdown-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: space-between; }
        .my-role-section .dropdown-container > * { flex-grow: 1; min-width: 120px; }
        .my-role-section select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; -webkit-appearance: none; -moz-appearance: none; appearance: none; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='%23666' d='M7 10l5 5 5-5H7z'/%3E%3C/svg%3E") no-repeat right 10px center / 12px; }
        .my-role-section #myRoleDisplay { margin-top: 15px; padding: 15px; background-color: var(--light-blue); border: 2px solid var(--secondary-color); border-radius: 8px; text-align: center; font-weight: bold; color: var(--secondary-color); display: none; }
        .my-role-line { display: flex; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .my-role-line select { flex-grow: 1; }
        .my-role-line input { flex-grow: 2; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; background-color: #f8f8f8; cursor: default; }
        .contact-info .popup-button { display: block; width: 100%; padding: 15px; background-color: var(--secondary-color); color: var(--white-color); border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; text-align: center; margin-top: 10px; }
        .contact-info .popup-button:hover { background-color: #286090; }
        .contact-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background-color: var(--white-color); padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); z-index: 1000; max-height: 80vh; overflow-y: auto; }
        .contact-popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; }
        .contact-popup h3 { margin-top: 0; color: var(--secondary-color); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .contact-list ul { list-style: none; padding: 0; margin: 0; }
        .contact-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .contact-list li:last-child { border-bottom: none; }
        .contact-list .contact-name { font-weight: bold; }
        .contact-list .contact-role { font-size: 0.9em; color: #666; }
        .contact-list .contact-phone { color: var(--primary-color); text-decoration: none; font-weight: bold; }
        .contact-popup .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5em; color: #aaa; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/hyunjiklee119-collab/whds_ert/main/whds_ert/IMAGES/WONIK.png" alt="WONIK HOLDINGS" class="wonik-logo">
            </div>
            <h1>화재대응 조직 임무</h1>
            <div class="contact-info">
                <h2>비상 연락망</h2>
                <ul>
                    <li>소방서: <a href="tel:119">119</a></li>
                    <li>원익 보안실: <a href="tel:031-230-4625">031-230-4625</a></li>
                    <li>소방안전관리자: <a href="tel:010-9466-9082">010-9466-9082</a></li>
                </ul>
                <button class="popup-button" onclick="showPopup()">전체 조직 연명부 보기</button>
            </div>
        </header>
        <main>
            <div class="card my-role-section">
                <h2>나의 임무 확인</h2>
                <div class="my-role-line">
                    <select id="departmentSelect">
                        <option value="">부서 선택</option>
                    </select>
                    <select id="nameSelect" disabled>
                        <option value="">이름 선택</option>
                    </select>
                    <input type="text" id="roleDisplay" placeholder="임무" readonly>
                </div>
            </div>
            <hr>
            <div class="card common-actions">
                <h2 id="dynamic-guideline-title"></h2>
                <div class="action-list" id="dynamic-guideline-content">
                    </div>
            </div>
            <hr>
            <div class="link-container">
                <a href="missions.html">역할별 임무 보기</a>
                <a href="manuals.html">안전 매뉴얼 보기</a>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="clearRosterCache()" style="padding: 8px 12px; background-color: #777; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                    🔄 연명부 정보 새로고침 (업데이트 시)
                </button>
            </div>
        </main>
    </div>
    
    <div id="contactPopupOverlay" class="contact-popup-overlay" onclick="hidePopup()"></div>
    <div id="contactPopup" class="contact-popup">
        <span class="close-btn" onclick="hidePopup()">&times;</span>
        <h3>비상 연락 조직</h3>
        <div class="contact-list">
            <ul>
                </ul>
        </div>
    </div>
    
    <script>
        // 1. [중요] 본인의 구글 앱스 스크립트 '배포 URL'을 여기에 입력하세요.
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzPfJvCXNSCXGg0KBCFdD0qsJfiI8LC5g6aZctDD3e3zxWojug0krC4YD_jKu3CZmn5/exec"; 

        let rosterData = []; 

        // --- 팝업 관련 함수 ---
        function showPopup() {
            document.getElementById('contactPopup').style.display = 'block';
            document.getElementById('contactPopupOverlay').style.display = 'block';
        }
        function hidePopup() {
            document.getElementById('contactPopup').style.display = 'none';
            document.getElementById('contactPopupOverlay').style.display = 'none';
        }

        // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
        // 1. 공통 피난 유도 템플릿 정의 (모든 피난 유도 역할이 공유하는 기본 수칙 틀)
        const EVAC_GUIDELINE_TEMPLATE = [
            "1. 담당 구역으로 즉시 이동하여 큰 소리로 <strong>화재를 전파</strong>하고, <strong>비상계단 및 비상구</strong>로 대피를 유도한다.",
            // [DYNAMIC_GUIDE] 마커는 아래 각 역할의 'guide' 내용으로 대체됩니다.
            "2. <strong>[DYNAMIC_GUIDE]</strong> 등 담당 구역 내 잔류 인원이 없는지 확인한다.", 
            "3. 대피 완료 후 <strong>최종 잔류자 없음</strong>을 보고하고, 집결지에서 인원 파악을 지원한다."
        ];
        
        // 2. 각 구역별 피난 유도 역할별 주의사항 (Title과 Guide만 정의)
        // GATE 지원 임무를 분리했습니다.
        const EVAC_ROLES = {
            "1F-1구역 피난유도": {
                title: "🚶 1F-1구역 피난유도 핵심 임무",
                guide: "로비, 교육장, 회의실, TC룸"
            },
            "1F-2구역 피난유도(정)": { 
                title: "🚶 1F-2구역 피난유도 핵심 임무 (정)",
                guide: "자재창고, GPU룸, 분석실"
            },
            "1F-2구역 피난유도(부)": { 
                title: "🚶 1F-2구역 피난유도 핵심 임무 (부)",
                guide: "자재창고, GPU룸, 분석실"
            },
            "1F-3구역 피난유도(정)": { 
                title: "🚶 1F-3구역 피난유도 핵심 임무 (정)",
                guide: "협력사크린룸, 협력사벤더룸(1F,2F)"
            },
            "1F-3구역 피난유도(부)": { 
                title: "🚶 1F-3구역 피난유도 핵심 임무 (부)",
                guide: "협력사크린룸, 협력사벤더룸(1F,2F)"
            },
            "1F-4구역 피난유도(정)": { 
                title: "🚶 1F-4구역 피난유도 핵심 임무 (정)",
                guide: "GSS룸, IGS룸, 출하장"
            },
            "1F-4구역 피난유도(부)": { 
                title: "🚶 1F-4구역 피난유도 핵심 임무 (부)",
                guide: "GSS룸, IGS룸, 출하장"
            },
            "2F 피난유도(정)": { 
                title: "🚶 2F 피난유도 핵심 임무 (정)",
                guide: "피트니스, 탈의실, 휴게실"
            },
            "2F 피난유도(부)": { 
                title: "🚶 2F 피난유도 핵심 임무 (부)",
                guide: "피트니스, 탈의실, 휴게실"
            },
            "3F-1구역 피난유도(정)": { 
                title: "🚶 3F-1구역 피난유도 핵심 임무 (정)",
                guide: "대회의실, 중·소회의실, 공용 사무실, 임원실"
            },
            "3F-1구역 피난유도(부)": { 
                title: "🚶 3F-1구역 피난유도 핵심 임무 (부)",
                guide: "대회의실, 중·소회의실, 공용 사무실, 임원실"
            },
            "3F-2구역 피난유도(정)": { 
                title: "🚶 3F-2구역 피난유도 핵심 임무 (정)",
                guide: "전산실, 서버실, 공조실, 제품 TEST실"
            },
            "3F-2구역 피난유도(부)": { 
                title: "🚶 3F-2구역 피난유도 핵심 임무 (부)",
                guide: "전산실, 서버실, 공조실, 제품 TEST실"
            },
            "4F 피난유도(정)": { 
                title: "🚶 4F 피난유도 핵심 임무 (정)",
                guide: "카페, 식당 및 주방, 직원휴게실"
            },
            "4F 피난유도(부)": { 
                title: "🚶 4F 피난유도 핵심 임무 (부)",
                guide: "카페, 식당 및 주방, 직원휴게실"
            },
            "B1F 피난유도(정)": { 
                title: "🚶 B1F 피난유도 핵심 임무 (정)",
                guide: "지하 연구실, 창고, 기계실, 전기실"
            },
            "B1F 피난유도(부)": { 
                title: "🚶 B1F 피난유도 핵심 임무 (부원)",
                guide: "지하 연구실, 창고, 기계실, 전기실"
            }
            // GATE 지원 임무는 아래 roleGuidelines 객체에 별도로 정의됨
        };

        // 3. [최종] roleGuidelines 객체 정의 (단일 역할 + 피난유도 역할 병합 + GATE 역할 별도 정의)
        const roleGuidelines = {
            // ----------------------- 지휘 및 상황관리 -----------------------
            "소방대장": {
                title: "🔥 소방대장 핵심 임무",
                guidelines: [
                    "1. <strong>최고 지휘권</strong>을 발동하고 상황실에서 재난 대응을 총괄 지휘한다.",
                    "2. 각 팀장들의 상황 보고를 받고 <strong>최종 대피 완료</strong>를 선언한다.",
                    "3. 외부 소방대가 도착하면 화재 정보 및 인명 잔류 현황을 <strong>신속하게 인계</strong>한다."
                ]
            },
            "부대장": {
                title: "🔥 부대장 핵심 임무",
                guidelines: [
                    "1. 소방대장 부재 시 지휘를 대행하며, 상황실의 <strong>보조 지휘 및 통제</strong>를 담당한다.",
                    "2. **각 팀장들과의 비상 연락망**을 유지하고, 명령 및 상황 보고를 신속하게 전달한다.",
                    "3. 소방대장의 지휘 활동을 보좌하고 <strong>기록 관리</strong> 및 후속 조치를 지원한다."
                ]
            },
            "상황관리자": {
                title: "🔔 상황관리자 핵심 임무",
                guidelines: [
                    "1. 화재 접수 시점부터 모든 상황을 <strong>시간대별로 상세히 기록</strong>하고 현황판을 업데이트한다.",
                    "2. <strong>인원 현황 및 잔류자 여부</strong> 보고를 취합하여 지휘부에 보고하는 통제 기능을 수행한다.",
                    "3. 지휘부 지시에 따른 <strong>추가 정보 취합 및 보고</strong>에 집중한다."
                ]
            },
            "비상연락관": {
                title: "📞 비상연락관 핵심 임무",
                guidelines: [
                    "1. <strong>119 신고를 재확인</strong>하고, <strong>비상 방송 및 소방시설 수신반을 조작</strong>한다.",
                    "2. 소방서, 경찰서 등 <strong>사내외 주요 기관과의 통신</strong> 및 연락을 전담한다.",
                    "3. 소방대 도착 시 <strong>현장 진입로 및 화재 정보</strong>를 신속하게 안내하고 인계한다."
                ]
            },
            // ----------------------- 초기 소화 및 응급 구조 -----------------------
            "초기소화 총괄": {
                title: "🧯 초기소화 총괄 핵심 임무",
                guidelines: [
                    "1. 화재 지점을 신속히 파악하고 <strong>초기 소화팀 출동 및 장비 사용</strong>을 지휘한다.",
                    "2. 소화 작업의 <strong>안전성</strong>을 확인하고, 소화 불가능 판단 시 <strong>즉시 철수 명령</strong>을 내린다.",
                    "3. 소방대 도착 시 화점 정보를 전달하고 외부 소방 활동을 지원한다."
                ]
            },
            "초기소화": {
                title: "🧯 초기소화 핵심 임무",
                guidelines: [
                    "1. 화재 지점으로 즉시 이동하여 <strong>소화기, 옥내소화전</strong>을 이용해 초기 소화를 시도한다.",
                    "2. 소화 불가능 판단 시 <strong>즉시 철수</strong>하며, 방호안전반에 <strong>화재 확산 방지 시설(방화문, 방화셔터, FAN 등)</strong> 조작을 요청한다.",
                    "3. <strong>주변 인원에게 화재를 알리고</strong> 대피를 유도하며, 소화 작업 중 인명 안전에 주의한다."
                ]
            },
            "응급구조 총괄": {
                title: "🩹 응급구조 총괄 핵심 임무",
                guidelines: [
                    "1. <strong>응급 구호소</strong> 운영을 총괄하고, 부상자 발생 시 응급구조반의 활동을 지휘한다.",
                    "2. 대피 인원의 <strong>건강 상태</strong>를 확인하고, 중증 부상자에 대한 응급처치를 지시 · 수행한다.",
                    "3. 부상자 현황 및 응급처치 결과를 <strong>정확하게 상황관리자에게 보고</strong>한다."
                ]
            },
            "응급·구조": {
                title: "🩹 응급·구조 핵심 임무",
                guidelines: [
                    "1. <strong>응급 구호 장비</strong>를 챙겨 응급 구호소로 이동하여 대기 및 준비한다.",
                    "2. 부상자 발생 시 현장에서 <strong>심폐소생술(CPR) 및 지혈</strong> 등 응급처치를 지원 · 수행한다.",
                    "3. <strong>119 구급대</strong>에 부상자를 안전하게 인계하고, 인계 사항을 상세히 기록한다."
                ]
            },
            // ----------------------- 시설 방호 및 복구 -----------------------
            "시설방호 총괄": {
                title: "🛡️ 시설방호 총괄 핵심 임무",
                guidelines: [
                    "1. 화재 위치 및 <strong>2차 피해 우려 요소</strong>를 파악하여 방호안전반의 활동을 지휘한다.",
                    "2. <strong>UT, 전기, 가스</strong> 등 주요 설비의 안전 차단 우선순위를 결정하고 확인한다.",
                    "3. 소방 활동에 필요한 <strong>장비 및 설비</strong>를 지원하고, 건물 내 중요 시설의 손상을 최소화한다."
                ]
            },
            "UT": {
                title: "🔌 UT(유틸리티) 방호 핵심 임무",
                guidelines: [
                    "1. 지정된 <strong>특정 유틸리티 차단 밸브</strong> (용수, 특수 가스 등)를 신속히 잠그고 <strong>인접 방화시설</strong>을 폐쇄한다.",
                    "2. 차단 전 주변 피난 인원에게 <strong>차단 사실을 명확히 고지</strong>하여 안전을 확보한다.",
                    "3. 차단 완료 및 현재 상태를 시설방호 총괄에게 보고한다."
                ]
            },
            "전기": {
                title: "⚡ 전기 방호 핵심 임무",
                guidelines: [
                    "1. 건물 내 <strong>주 전원 및 화재 구역의 비상 전원</strong>을 차단하고, <strong>인접 방화문</strong>을 폐쇄하여 2차 감전사고를 방지한다.",
                    "2. <strong>비상 발전기</strong> 가동 상태를 확인하고, 최소한의 피난 유도 조명을 유지한다.",
                    "3. 전기 차단 완료 및 현재 상태를 시설방호 총괄에게 보고한다."
                ]
            },
            "가스": {
                title: "🛢️ 가스 방호 핵심 임무",
                guidelines: [
                    "1. 건물로 유입되는 <strong>주요 가스 공급 밸브</strong>를 신속하게 차단하고, <strong>인접 방화문</strong>을 폐쇄한다.",
                    "2. 가스 차단 후 잔류 가스 등 <strong>2차 위험 요소</strong>를 점검하고 안전 구역으로 대피한다.",
                    "3. 가스 차단 완료 및 현재 상태를 시설방호 총괄에게 보고한다."
                ]
            },
            // ----------------------- 구역별 피난 유도 (EVAC_ROLES 내용이 여기에 개별적으로 들어갑니다) -----------------------
            "1F-1구역 피난유도": {
                title: EVAC_ROLES["1F-1구역 피난유도"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-1구역 피난유도"].guide}</strong>`))
            },
            "1F-2구역 피난유도(정)": {
                title: EVAC_ROLES["1F-2구역 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-2구역 피난유도(정)"].guide}</strong>`))
            },
            "1F-2구역 피난유도(부)": {
                title: EVAC_ROLES["1F-2구역 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-2구역 피난유도(부)"].guide}</strong>`))
            },
            "1F-3구역 피난유도(정)": {
                title: EVAC_ROLES["1F-3구역 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-3구역 피난유도(정)"].guide}</strong>`))
            },
            "1F-3구역 피난유도(부)": {
                title: EVAC_ROLES["1F-3구역 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-3구역 피난유도(부)"].guide}</strong>`))
            },
            "1F-4구역 피난유도(정)": {
                title: EVAC_ROLES["1F-4구역 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-4구역 피난유도(정)"].guide}</strong>`))
            },
            "1F-4구역 피난유도(부)": {
                title: EVAC_ROLES["1F-4구역 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["1F-4구역 피난유도(부)"].guide}</strong>`))
            },
            "2F 피난유도(정)": {
                title: EVAC_ROLES["2F 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["2F 피난유도(정)"].guide}</strong>`))
            },
            "2F 피난유도(부)": {
                title: EVAC_ROLES["2F 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["2F 피난유도(부)"].guide}</strong>`))
            },
            "3F-1구역 피난유도(정)": {
                title: EVAC_ROLES["3F-1구역 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["3F-1구역 피난유도(정)"].guide}</strong>`))
            },
            "3F-1구역 피난유도(부)": {
                title: EVAC_ROLES["3F-1구역 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["3F-1구역 피난유도(부)"].guide}</strong>`))
            },
            "3F-2구역 피난유도(정)": {
                title: EVAC_ROLES["3F-2구역 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["3F-2구역 피난유도(정)"].guide}</strong>`))
            },
            "3F-2구역 피난유도(부)": {
                title: EVAC_ROLES["3F-2구역 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["3F-2구역 피난유도(부)"].guide}</strong>`))
            },
            "4F 피난유도(정)": {
                title: EVAC_ROLES["4F 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["4F 피난유도(정)"].guide}</strong>`))
            },
            "4F 피난유도(부)": {
                title: EVAC_ROLES["4F 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["4F 피난유도(부)"].guide}</strong>`))
            },
            "B1F 피난유도(정)": {
                title: EVAC_ROLES["B1F 피난유도(정)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["B1F 피난유도(정)"].guide}</strong>`))
            },
            "B1F 피난유도(부)": {
                title: EVAC_ROLES["B1F 피난유도(부)"].title,
                guidelines: EVAC_GUIDELINE_TEMPLATE.map(g => g.replace('[DYNAMIC_GUIDE]', `<strong>${EVAC_ROLES["B1F 피난유도(부)"].guide}</strong>`))
            },
            
            // ----------------------- GATE 피난안내 · 지원 (별도 임무) -----------------------
            "GATE1 피난안내 · 지원": {
                title: "➡️ GATE1 피난안내 · 지원 핵심 임무",
                guidelines: [
                    "1. <strong>GATE1</strong>으로 즉시 이동하여 <strong>비상 집결지</strong>로 안내하며, 지휘부 요청 시 <strong>건물 내 피난유도팀으로 증원</strong> 지원을 한다.", 
                    "2. 대피 인원이 <strong>위험 지역</strong> (소방대 진입로, 화재 건물 인접지)으로 접근하지 못하도록 경계선을 확보하고 통제한다.",
                    "3. 외부에서 건물로의 <strong>진입을 통제</strong>하고, 인원 파악 및 상황 보고 활동을 지원한다."
                ]
            },
            "GATE2 피난안내 · 지원": {
                title: "➡️ GATE2 피난안내 · 지원 핵심 임무",
                guidelines: [
                    "1. <strong>GATE2</strong>으로 즉시 이동하여 <strong>비상 집결지</strong>로 안내하며, 지휘부 요청 시 <strong>건물 내 피난유도팀으로 증원</strong> 지원을 한다.", 
                    "2. 대피 인원이 <strong>위험 지역</strong> (소방대 진입로, 화재 건물 인접지)으로 접근하지 못하도록 경계선을 확보하고 통제한다.",
                    "3. 외부에서 건물로의 <strong>진입을 통제</strong>하고, 인원 파악 및 상황 보고 활동을 지원한다."

                ]
            },
            // ----------------------- 기본 값 (역할 미선택/미정의) -----------------------
            "default": {
                title: "🔥 화재 발생 시 가장 먼저 해야 할 일 (공통)",
                guidelines: [
                    "1. <strong>\"불이야!\"</strong> 크게 외쳐 주변에 화재를 알립니다.",
                    "2. 건물 내 <strong>비상벨</strong> (수동 발신기)을 누릅니다.",
                    "3. <strong>119에 신고</strong>하고, 인명 피해가 없도록 대피를 유도합니다."
                ]
            }
        };

        // ----------------------------------------------------------------------------------
        // [수정] displayGuidelines 함수: EVAC_ROLES 항목 처리 로직 제거 (roleGuidelines에 병합됨)
        // ----------------------------------------------------------------------------------
        function displayGuidelines(role) {
            const titleElement = document.getElementById('dynamic-guideline-title');
            const contentElement = document.getElementById('dynamic-guideline-content');

            // roleGuidelines에서 직접 찾고, 없으면 default 사용
            const data = roleGuidelines[role] || roleGuidelines['default'];
            titleElement.innerHTML = data.title;
            const finalGuidelines = data.guidelines;

            // 내용을 업데이트
            contentElement.innerHTML = finalGuidelines.map((item, index) => {
                if (/^\d+\./.test(item.trim())) {
                    const numberMatch = item.match(/^(\d+)\./);
                    const number = numberMatch ? numberMatch[1] : (index + 1);
                    const text = item.replace(/^\d+\.\s*/, ''); 
                    return `<p class="numbered-guideline" data-number="${number}">${text}</p>`;
                } else {
                    return `<p>${item}</p>`;
                }
            }).join('');
        }
        // ----------------------------------------------------------------------------------


        // --- 명단 캐시 삭제 함수 ---
        function clearRosterCache() {
            localStorage.removeItem("cachedRosterData");
            localStorage.removeItem('savedDepartment');
            localStorage.removeItem('savedName');
            alert('명단 캐시가 삭제되었습니다. 페이지를 새로고침하여 새 명단을 불러옵니다.');
            location.reload();
        }

        // --- 페이지 로드 및 명단 처리 (캐시 로직 포함) ---
        document.addEventListener('DOMContentLoaded', () => {
            if (WEB_APP_URL === "YOUR WEB APP URL HERE" || !WEB_APP_URL) {
                alert("HTML 파일 하단 <script> 태그의 WEB_APP_URL 변수에 본인의 구글 앱스 스크립트 배포 URL을 입력해주세요.");
                console.error("WEB_APP_URL이 설정되지 않았습니다.");
                return;
            }

            const CACHE_KEY = "cachedRosterData";
            const cachedData = localStorage.getItem(CACHE_KEY);

            if (cachedData) {
                console.log("로컬 캐시에서 명단 로드 (빠름)");
                rosterData = JSON.parse(cachedData);
                
                populateDropdowns();
                populateContactList();
                displayGuidelines(null); // 초기 수칙 표시

            } else {
                console.log("네트워크에서 명단 로드 (느림)");
                document.querySelector('.contact-list ul').innerHTML = '<li>명단 로딩 중...</li>';
                const callbackName = 'jsonp_callback_' + Math.floor(Math.random() * 100000);

                window[callbackName] = function(response) {
                    console.log("Google Apps Script 응답:", response);

                    if (response.result === 'success' && response.data) {
                        rosterData = response.data;
                        
                        try {
                            localStorage.setItem(CACHE_KEY, JSON.stringify(rosterData));
                            console.log("명단을 로컬 캐시에 저장했습니다.");
                        } catch (e) {
                            console.error("로컬 캐시 저장 실패:", e);
                        }
                        
                        populateDropdowns();
                        populateContactList();
                        displayGuidelines(null);

                    } else {
                        console.error('Error loading the roster:', response.message);
                        alert('명단을 불러오는 데 실패했습니다: ' + (response.message || '알 수 없는 오류'));
                        document.querySelector('.contact-list ul').innerHTML = '<li>명단 로드 실패</li>';
                    }
                    document.body.removeChild(script);
                    delete window[callbackName];
                };

                const script = document.createElement('script');
                script.src = `${WEB_APP_URL}?action=readRoster&callback=${callbackName}`;
                document.body.appendChild(script);
            }
        });

        // --- 드롭다운 채우는 함수 (localStorage 저장/로드 기능 포함) ---
        function populateDropdowns() {
            const departmentSelect = document.getElementById('departmentSelect');
            const nameSelect = document.getElementById('nameSelect');
            const roleDisplay = document.getElementById('roleDisplay');

            // 부서 목록 채우기
            const departments = [...new Set(rosterData.map(p => p.department))].sort();
            departments.forEach(dept => {
                if (!dept) return;
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });

            // 저장된 부서 값 불러오기
            const savedDept = localStorage.getItem('savedDepartment');
            if (savedDept) {
                departmentSelect.value = savedDept;
            }

            // --- 부서 변경 이벤트 리스너 ---
            departmentSelect.addEventListener('change', () => {
                const selectedDept = departmentSelect.value;
                localStorage.setItem('savedDepartment', selectedDept);
                localStorage.removeItem('savedName'); 

                nameSelect.innerHTML = '<option value="">이름 선택</option>';
                nameSelect.disabled = true;
                roleDisplay.value = '';
                displayGuidelines(null); 

                if (selectedDept) {
                    const namesInDept = rosterData.filter(p => p.department === selectedDept).map(p => p.name).sort();
                    namesInDept.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        nameSelect.appendChild(option);
                    });
                    nameSelect.disabled = false;

                    const savedName = localStorage.getItem('savedName');
                    if (savedName) {
                        nameSelect.value = savedName;
                    }
                }
            });

            // 페이지 로드 시 change 이벤트를 수동으로 트리거 (부서)
            if (savedDept) {
                departmentSelect.dispatchEvent(new Event('change'));
            }

            // --- 이름 변경 이벤트 리스너 ---
            nameSelect.addEventListener('change', () => {
                const selectedName = nameSelect.value;
                localStorage.setItem('savedName', selectedName);

                roleDisplay.value = '';
                let currentRole = null; 

                if (selectedName) {
                    const person = rosterData.find(p => p.name === selectedName && p.department === departmentSelect.value);
                    if (person) {
                        roleDisplay.value = person.role;
                        currentRole = person.role;
                    }
                }
                displayGuidelines(currentRole);
            });

            // 페이지 로드 시 change 이벤트를 수동으로 트리거 (이름)
            if (savedDept && localStorage.getItem('savedName')) {
                nameSelect.dispatchEvent(new Event('change'));
            }
        }

        // --- 팝업 연락망 채우는 함수 ---
        function populateContactList() {
            const contactList = document.querySelector('.contact-list ul');
            contactList.innerHTML = ''; 

            if (rosterData.length === 0) {
                contactList.innerHTML = '<li>등록된 연락처가 없습니다.</li>';
                return;
            }

            rosterData.forEach(person => {
                if (!person.name || !person.department || !person.role) return;

                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div>
                        <span class="contact-name">${person.name}</span>
                        <br>
                        <span class="contact-role">${person.department} - ${person.role}</span>
                    </div>
                    ${person.phone ? `<a href="tel:${person.phone}" class="contact-phone">📞 전화</a>` : ''}
                `;
                contactList.appendChild(listItem);
            });
        }
    </script>
</body>
</html>
